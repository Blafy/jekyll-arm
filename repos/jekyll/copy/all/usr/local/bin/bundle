#!/bin/sh
[ "$JEKYLL_DEBUG" = "true" ] && set -x
set -e

if [ ! -f "/updated" ] && connected && [ -f ".apk" ]; then
  apk add --no-cache --no-progress $(cat .apk)
fi

exe=$(which -a bundle | grep -v /usr/local/bin | head -n1)
if [ "$1" = "install"] || [ "$1" = "clean" ]; then
  if [ "$(stat -c '%U' $GEM_HOME)" != "jekyll" ]; then
    chown -R jekyll:jekyll $GEM_HOME
  fi
fi

# --
if [ "$1" = "install" ]; then
  if ! su-exec jekyll $exe check; then
    su-exec jekyll $exe config jobs 2
    su-exec jekyll $exe config ignore_messages true
    su-exec jekyll $exe config build.nokogiri --use-system-libraries
    su-exec jekyll $exe config disable_version_check true
    su-exec jekyll $exe install
    su-exec jekyll $exe clean
  fi
else
  su-exec jekyll $exe "$@"
fi
