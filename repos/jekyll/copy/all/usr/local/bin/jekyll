#!/bin/bash
[ "$JEKYLL_DEBUG" = "true" ] && set -x
set -e


if [ -z "$CONNECTED" ]; then
  export CONNECTED=true

  # --
  # Use WGet to work out if we are connected to the
  # internet, this way we can disable things like bundle
  # if the user wishes to not use the internet.
  # --

  wget -qs https://google.com >/dev/null || export CONNECTED=false
fi

: ${JEKYLL_UID:=$UID}
if [ "$JEKYLL_UID" != "0" ] && [ "$JEKYLL_UID" != "$(id -u jekyll)" ]; then

  # --
  # On the CI you should do `JEKYLL_UID=$(id -u $USER)`
  # This will prevent most permission errors even when there
  # is a lot of caching going on.
  # --

  reset-user jekyll:"$JEKYLL_UID"
fi

chown -R jekyll:jekyll $PWD
if [ "$CONNECTED" = "true" ]
  then /usr/local/bin/depends install
fi

status=0
CMD="/usr/bin/jekyll"
[ -f Gemfile ] && CMD="bundle exec ruby $CMD"
sudo -EHu jekyll $CMD $(/usr/local/bin/default-args $@) || exit $?
# ^ I don't know if the exit is necessary with `set -e`?
