#!/bin/bash
set -e

BUNDLE_ARGS="--jobs=1"

if [ ! -f "/updated" ]; then
  if connected; then
    if [ -f ".apk" ]; then
      apk add --no-progress $(cat .apk)
    fi
  fi
fi

chown -R jekyll:jekyll $PWD
if [ -f "Gemfile" ]; then
  if [ "$BUNDLE_CACHE" = "true" ]; then
    BUNDLE_ARGS="$BUNDLE_ARGS --path=vendor/bundle"
  fi

  # --

  if [ "$1" = "install" ]; then
    if ! bundle check; then
      sudo -EHu jekyll bundle install $BUNDLE_ARGS
    fi

  else
    sudo -EHu jekyll bundle "$@"
  fi
fi
