#!/bin/sh
set -e

if [ "$JEKYLL_DOCKER_NAME" = "minimal" ] || [ "$JEKYLL_DOCKER_TAG" = "pages" ]
then
  exit 0
else
  if [ ! -f "/updated" ] && connected && [ -f ".apk" ]; then
    sudo apk add --no-cache --no-progress $(cat .apk)
  fi
fi

chown -R jekyll:jekyll $PWD
if [ -f "Gemfile" ]; then
  if [ "$BUNDLE_CACHE" = "true" ]; then
    unset BUNDLE_PATH

    su-exec jekyll bundle config path vendor/bundle
    su-exec jekyll bundle config disable_shared_gems true
    su-exec jekyll bundle config jobs 2
  fi

  # --

  if [ "$1" = "install" ]; then
    if ! su-exec jekyll bundle check; then
      su-exec jekyll bundle config ignore_messages true
      su-exec jekyll bundle config build.nokogiri --use-system-libraries
      su-exec jekyll bundle config disable_version_check true
      su-exec jekyll bundle install
    fi

  else
    su-exec jekyll bundle "$@"
  fi
fi
